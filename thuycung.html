<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thủy Cung 3D — Nhấn để mở</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    #wrap{height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(#05213a,#00121a);color:#cce7ff}
    #openBtn{appearance:none;border:0;padding:18px 28px;border-radius:12px;background:linear-gradient(90deg,#2ab7f5,#0066ff);color:white;font-size:18px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.4)}
    #descr{position:fixed;left:18px;bottom:18px;color:#a9dff7;opacity:.9}
    #canvas-container{position:fixed;inset:0;display:none}
    .overlay-ui{position:fixed;top:12px;right:12px;z-index:10}
    .pill{backdrop-filter:blur(6px);background:rgba(255,255,255,0.06);padding:8px 12px;border-radius:999px;color:#e6f7ff}
    #hint{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;color:#cfeeff}
  </style>
</head>
<body>
  <div id="wrap">
    <div style="text-align:center">
      <h1 style="margin:0 0 10px">Thủy Cung 3D</h1>
      <p style="margin:0 0 22px;opacity:.9">Nhấn nút để mở cảnh thủy cung 3D tương tác</p>
      <button id="openBtn">Mở Thủy Cung</button>
    </div>
    <div id="descr">Nhấn và kéo để di chuyển camera • Phím R để reset</div>
  </div>

  <div id="canvas-container"></div>
  <div class="overlay-ui"><div class="pill" id="stats">Đang tắt</div></div>
  <div id="hint">Nhấn <strong>Space</strong> để bật/tắt bong bóng</div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js';

    const openBtn = document.getElementById('openBtn');
    const container = document.getElementById('canvas-container');
    const wrap = document.getElementById('wrap');
    const statsEl = document.getElementById('stats');

    let renderer, scene, camera, controls, clock;
    let fishes = [], bubbles = [];
    let bubblesEnabled = true;

    openBtn.addEventListener('click', initAndStart);

    function initAndStart(){
      wrap.style.display = 'none';
      container.style.display = 'block';
      document.body.style.cursor = 'none';
      init();
      animate();
    }

    function init(){
      clock = new THREE.Clock();
      renderer = new THREE.WebGLRenderer({antialias:true});
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.toneMappingExposure = 1.0;
      container.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      scene.fog = new THREE.FogExp2(0x001926, 0.06);

      camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 200);
      camera.position.set(0, 4, 12);

      // Lights
      const hemi = new THREE.HemisphereLight(0x88bbff, 0x001022, 0.7);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xbbeeff, 0.8);
      dir.position.set(5,10,7);
      scene.add(dir);

      // Floor / sand
      const sandGeo = new THREE.CircleGeometry(30, 64);
      const sandMat = new THREE.MeshStandardMaterial({color:0x2a200c, roughness:1, metalness:0});
      const sand = new THREE.Mesh(sandGeo, sandMat);
      sand.rotation.x = -Math.PI/2;
      sand.position.y = -6;
      scene.add(sand);

      // Plants
      for(let i=0;i<20;i++) createPlant((Math.random()-0.5)*20, -5.8, (Math.random()-0.5)*12, (1+Math.random()*1.6));

      // Rocks
      for(let i=0;i<8;i++){
        const g = new THREE.DodecahedronGeometry(0.6 + Math.random()*1.5,0);
        const m = new THREE.MeshStandardMaterial({color:0x39403a, roughness:1});
        const rock = new THREE.Mesh(g,m);
        rock.position.set((Math.random()-0.5)*18, -5.5, (Math.random()-0.5)*12);
        rock.scale.setScalar(1+Math.random()*1.8);
        scene.add(rock);
      }

      // Create fishes
      for(let i=0;i<18;i++) fishes.push(createFish());

      // Create bubbles pool
      for(let i=0;i<80;i++) bubbles.push(createBubble());

      // Controls
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.minDistance = 4;
      controls.maxDistance = 40;
      controls.maxPolarAngle = Math.PI/2 - 0.1;

      window.addEventListener('resize', onWindowResize);
      window.addEventListener('keydown', onKey);
    }

    function createPlant(x,y,z,scale=1){
      const bladeCount = 5 + Math.floor(Math.random()*6);
      for(let i=0;i<bladeCount;i++){
        const geom = new THREE.PlaneGeometry(0.12*scale,1.6*scale,4,8);
        geom.translate(0,0.8*scale,0);
        const mat = new THREE.MeshStandardMaterial({color:0x0a5a36, side:THREE.DoubleSide, roughness:1});
        const mesh = new THREE.Mesh(geom, mat);
        mesh.position.set(x + (Math.random()-0.5)*0.4, y, z + (Math.random()-0.5)*0.4);
        mesh.rotation.y = Math.random()*Math.PI;
        mesh.userData = {phase: Math.random()*Math.PI*2};
        mesh.scale.set(1,1,1);
        scene.add(mesh);
      }
    }

    function createFish(){
      const group = new THREE.Group();
      const bodyGeo = new THREE.ConeGeometry(0.3, 1.2, 12);
      const bodyMat = new THREE.MeshStandardMaterial({color: new THREE.Color().setHSL(Math.random(),0.7,0.5), roughness:0.7, metalness:0.1});
      const body = new THREE.Mesh(bodyGeo, bodyMat);
      body.rotation.z = Math.PI/2;
      body.position.x = 0.0;
      group.add(body);

      const tailGeo = new THREE.ConeGeometry(0.2,0.4,8);
      const tailMat = new THREE.MeshStandardMaterial({color:0x111111, roughness:1});
      const tail = new THREE.Mesh(tailGeo, tailMat);
      tail.position.set(-0.7,0,0);
      tail.rotation.z = -Math.PI/2;
      group.add(tail);

      // random position
      group.position.set((Math.random()-0.5)*18, (Math.random()*6)-2, (Math.random()-0.5)*12);
      group.rotation.y = Math.random()*Math.PI*2;

      group.userData = {
        speed: 0.8 + Math.random()*1.6,
        wobble: 0.8 + Math.random()*1.4,
        phase: Math.random()*Math.PI*2,
        radius: 0.5 + Math.random()*3
      };

      scene.add(group);
      return group;
    }

    function createBubble(){
      const geom = new THREE.SphereGeometry(0.06 + Math.random()*0.2, 10, 8);
      const mat = new THREE.MeshStandardMaterial({color:0xcfefff, transparent:true, opacity:0.6, metalness:0.1, roughness:0.3});
      const mesh = new THREE.Mesh(geom, mat);
      resetBubble(mesh, true);
      scene.add(mesh);
      return mesh;
    }

    function resetBubble(b, init=false){
      b.position.set((Math.random()-0.5)*16, -5 + (init? Math.random()*3:0), (Math.random()-0.5)*12);
      b.userData = {speed: 0.6 + Math.random()*1.6, life: 0};
      b.scale.setScalar(1);
      b.material.opacity = 0.6;
    }

    function onWindowResize(){
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onKey(e){
      if(e.code === 'KeyR'){
        camera.position.set(0,4,12);
        controls.target.set(0,0,0);
      }
      if(e.code === 'Space'){
        bubblesEnabled = !bubblesEnabled;
        statsEl.textContent = bubblesEnabled ? 'Bong bóng: Bật' : 'Bong bóng: Tắt';
      }
    }

    function animate(){
      requestAnimationFrame(animate);
      const t = clock.getElapsedTime();

      // animate plants (sway)
      scene.traverse(obj=>{
        if(obj.isMesh && obj.geometry.type === 'PlaneGeometry'){
          obj.rotation.z = Math.sin(t + (obj.userData.phase||0))*0.06;
        }
      });

      // fishes movement
      for(let i=0;i<fishes.length;i++){
        const f = fishes[i];
        const ud = f.userData;
        // simple flock-like orbiting + forward motion
        f.userData.phase += 0.01 * ud.speed;
        f.position.x += Math.cos(t*ud.wobble + ud.phase) * 0.002 * ud.speed;
        f.position.y += Math.sin(t*ud.wobble + ud.phase)*0.003 * ud.speed;
        // forward direction
        const dir = new THREE.Vector3(Math.cos(ud.phase + t*0.2), Math.sin(t*0.1+ud.phase)*0.2, Math.sin(ud.phase + t*0.13));
        f.position.addScaledVector(dir.normalize(), 0.01 * ud.speed);

        // keep within bounds — bounce
        if(f.position.x > 18) f.position.x = -18;
        if(f.position.x < -18) f.position.x = 18;
        if(f.position.y > 6) f.position.y = -2;
        if(f.position.y < -6) f.position.y = 6;
        if(f.position.z > 12) f.position.z = -12;
        if(f.position.z < -12) f.position.z = 12;

        // rotate to travel direction
        const vel = dir.clone().normalize();
        const look = new THREE.Vector3().copy(vel);
        const targetQuat = new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(1,0,0), look);
        f.quaternion.slerp(targetQuat, 0.05);
      }

      // bubbles
      for(let i=0;i<bubbles.length;i++){
        const b = bubbles[i];
        if(!bubblesEnabled){ b.visible = false; continue; } else b.visible = true;
        b.position.y += 0.01 * b.userData.speed;
        b.position.x += Math.sin(t*0.5 + i)*0.002;
        b.userData.life += 0.01 * b.userData.speed;
        b.material.opacity = 0.7 - (b.userData.life*0.05);
        if(b.position.y > 8 || b.userData.life > 60){
          resetBubble(b);
        }
      }

      controls.update();
      renderer.render(scene, camera);
    }

  </script>
</body>
</html>
